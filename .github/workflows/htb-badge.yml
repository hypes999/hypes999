name: Hack The Box Badge (simple)

on:
  schedule:
    - cron: '0 0 * * *'   # daily at 00:00 UTC
  workflow_dispatch:     # allow manual runs

permissions:
  contents: write

jobs:
  update-htb-badge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure assets folder exists
        run: mkdir -p ./assets

      - name: Download HTB badge image
        run: |
          HTB_ID=2660530
          BADGE_URL="https://www.hackthebox.com/badge/image/${HTB_ID}"
          TMP="./assets/htb_badge.tmp.png"
          OUT="./assets/htb_badge.png"

          # download to tmp file (fail workflow if download fails)
          curl -fsSL "$BADGE_URL" -o "$TMP"

          # if out doesn't exist -> move tmp to out
          if [ ! -f "$OUT" ]; then
            mv "$TMP" "$OUT"
            echo "Saved new badge to $OUT"
            exit 0
          fi

          # compare; if different replace
          if ! cmp -s "$TMP" "$OUT"; then
            mv "$TMP" "$OUT"
            echo "Badge changed -> updated $OUT"
          else
            echo "Badge unchanged -> no update"
            rm -f "$TMP"
            # Exit with 0; next step will check git diff and do nothing
          fi

      - name: Commit & push if changed
        run: |
          git config user.name "htb-bot"
          git config user.email "htb@bot.com"
          git add ./assets/htb_badge.png || true

          # If there is anything to commit, commit & push
          if ! git diff --cached --quiet; then
            git commit -m "Auto-update HTB badge (id:2660530)"
            git push
          else
            echo "No changes to commit."
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

name: Hack The Box Badge (auto resize + align)

on:
  schedule:
    - cron: '0 */6 * * *'   # executa a cada 6 horas
  workflow_dispatch:         # permite executar manualmente no separador Actions

permissions:
  contents: write

jobs:
  update-htb-badge:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure assets folder exists
        run: mkdir -p ./assets

      - name: Download HTB badge image
        run: |
          HTB_ID=2660530
          BADGE_URL="https://www.hackthebox.eu/badge/image/${HTB_ID}"
          TMP="./assets/htb_badge.tmp.png"
          OUT="./assets/htb_badge.png"

          echo "üì• A transferir badge de $BADGE_URL ..."
          curl -fsSL "$BADGE_URL" -o "$TMP"

          # Se o ficheiro principal ainda n√£o existir, grava logo
          if [ ! -f "$OUT" ]; then
            mv "$TMP" "$OUT"
            echo "Guardado novo badge em $OUT"
            exit 0
          fi

          # Se o ficheiro mudou, substitui
          if ! cmp -s "$TMP" "$OUT"; then
            mv "$TMP" "$OUT"
            echo "Badge alterado -> atualizado $OUT"
          else
            echo "Badge sem altera√ß√µes -> nada a atualizar"
            rm -f "$TMP"
          fi

      - name: Install ImageMagick
        run: sudo apt-get update && sudo apt-get install -y imagemagick

      - name: Resize & pad HTB badge to 329x88 (visual align)
        run: |
          IN="./assets/htb_badge.png"
          TMP="./assets/htb_badge_resized.png"
          FINAL="./assets/htb_badge.png"
          TARGET_W=329
          TARGET_H=88

          if [ ! -f "$IN" ]; then
            echo "Ficheiro n√£o encontrado: $IN"
            exit 0
          fi

          echo "Redimensionar e alinhar visualmente..."

          # Redimensionar mantendo propor√ß√£o pela altura
          convert "$IN" -resize x${TARGET_H} "$TMP"

          # Obter dimens√µes ap√≥s resize
          W=$(identify -format "%w" "$TMP")
          H=$(identify -format "%h" "$TMP")

          # Ajustar se ultrapassar largura
          if [ "$W" -gt "$TARGET_W" ]; then
            convert "$TMP" -resize ${TARGET_W}x "$TMP"
            W=$(identify -format "%w" "$TMP")
            H=$(identify -format "%h" "$TMP")
          fi

          # Criar canvas e deslocar ligeiramente o conte√∫do para cima (-6 px)
          convert -size ${TARGET_W}x${TARGET_H} xc:none \
                  -gravity center -geometry +0-6 "$TMP" -composite "$FINAL"

          rm -f "$TMP"
          echo "Badge final gravado em $FINAL"

      - name: Commit & push if changed
        run: |
          git config user.name "htb-bot"
          git config user.email "htb@bot.com"
          git add ./assets/htb_badge.png || true
          if ! git diff --cached --quiet; then
            git commit -m "Auto-update Hack The Box badge (id:2660530)"
            git push
            echo "Commit enviado."
          else
            echo "Sem altera√ß√µes para commitar."
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

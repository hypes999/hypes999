name: Hack The Box Badge (final)

on:
  schedule:
    - cron: '0 0 * * *'   # daily at 00:00 UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-htb-badge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure assets folder exists
        run: mkdir -p ./assets

      - name: Download HTB badge image
        run: |
          HTB_ID=2660530
          BADGE_URL="https://www.hackthebox.eu/badge/image/${HTB_ID}"
          TMP="./assets/htb_badge.tmp.png"
          OUT="./assets/htb_badge.png"

          echo "Fetching badge from $BADGE_URL ..."
          curl -fsSL "$BADGE_URL" -o "$TMP"

          if [ ! -f "$OUT" ]; then
            mv "$TMP" "$OUT"
            echo "Saved first badge image to $OUT"
            exit 0
          fi

          if ! cmp -s "$TMP" "$OUT"; then
            mv "$TMP" "$OUT"
            echo "Badge changed -> updated $OUT"
          else
            echo "Badge unchanged -> no update"
            rm -f "$TMP"
          fi

      - name: Commit & push if changed
        run: |
          git config user.name "htb-bot"
          git config user.email "htb@bot.com"
          git add ./assets/htb_badge.png || true
          if ! git diff --cached --quiet; then
            git commit -m "Auto-update HTB badge (id:2660530)"
            git push
          else
            echo "No changes to commit."
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
